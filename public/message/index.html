<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="referrer" content="no-referrer" />
        <meta name="theme-color" content="#000000" />

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,200..900;1,200..900&family=Space+Grotesk:wght@300..700&family=UnifrakturMaguntia&family=JetBrains+Mono:wght@400;500&display=swap"
            rel="stylesheet"
        />

        <title>message - Mufeed VH</title>

        <link rel="icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="stylesheet" href="/styles.css" />

        <link rel="alternate" type="application/rss+xml" title="RSS" href="https://mufeedvh.com/rss.xml" />
    </head>
    <body>
        <!-- SVG Icons -->
        <svg xmlns="http://www.w3.org/2000/svg" style="display: none">
            <symbol id="icon-link" viewBox="0 0 640 512">
                <path
                    d="M579.8 267.7c56.5-56.5 56.5-148 0-204.5c-50-50-128.8-56.5-186.3-15.4l-1.6 1.1c-14.4 10.3-17.7 30.3-7.4 44.6s30.3 17.7 44.6 7.4l1.6-1.1c32.1-22.9 76-19.3 103.8 8.6c31.5 31.5 31.5 82.5 0 114L422.3 334.8c-31.5 31.5-82.5 31.5-114 0c-27.9-27.9-31.5-71.8-8.6-103.8l1.1-1.6c10.3-14.4 6.9-34.4-7.4-44.6s-34.4-6.9-44.6 7.4l-1.1 1.6C206.5 251.2 213 330 263 380c56.5 56.5 148 56.5 204.5 0L579.8 267.7zM60.2 244.3c-56.5 56.5-56.5 148 0 204.5c50 50 128.8 56.5 186.3 15.4l1.6-1.1c14.4-10.3 17.7-30.3 7.4-44.6s-30.3-17.7-44.6-7.4l-1.6 1.1c-32.1 22.9-76 19.3-103.8-8.6C74 372 74 321 105.5 289.5L217.7 177.2c31.5-31.5 82.5-31.5 114 0c27.9 27.9 31.5 71.8 8.6 103.9l-1.1 1.6c-10.3 14.4-6.9 34.4 7.4 44.6s34.4 6.9 44.6-7.4l1.1-1.6C433.5 260.8 427 182 377 132c-56.5-56.5-148-56.5-204.5 0L60.2 244.3z"
                />
            </symbol>
            <symbol id="icon-message" viewBox="0 0 512 512">
                <path
                    d="M64 0C28.7 0 0 28.7 0 64V352c0 35.3 28.7 64 64 64h96v80c0 6.1 3.4 11.6 8.8 14.3s11.9 2.1 16.8-1.5L309.3 416H448c35.3 0 64-28.7 64-64V64c0-35.3-28.7-64-64-64H64z"
                />
            </symbol>
            <symbol id="icon-rabbit" viewBox="0 0 100 100">
                <!-- Hole -->
                <ellipse cx="50" cy="80" rx="45" ry="12" fill="currentColor" />
                <!-- Rabbit Head peeking -->
                <path
                    d="M28 80c0-20 12-32 22-32s22 12 22 32"
                    fill="var(--bg-deep)"
                    stroke="currentColor"
                    stroke-width="5"
                />
                <!-- Left Ear -->
                <path
                    d="M38 52c-8-25-2-42 5-42s8 17 5 42"
                    fill="var(--bg-deep)"
                    stroke="currentColor"
                    stroke-width="5"
                />
                <!-- Right Ear -->
                <path
                    d="M62 52c8-25 2-42-5-42s-8 17-5 42"
                    fill="var(--bg-deep)"
                    stroke="currentColor"
                    stroke-width="5"
                />
                <!-- Eyes -->
                <circle cx="43" cy="70" r="4" fill="currentColor" />
                <circle cx="57" cy="70" r="4" fill="currentColor" />
                <!-- Nose -->
                <circle cx="50" cy="77" r="2.5" fill="currentColor" />
            </symbol>
        </svg>

        <aside class="sidebar">
            <a href="/" class="logo-monogram">
                <span class="m-letter">M</span>
                <div class="name-extension">
                    <span>U</span>
                    <span>F</span>
                    <span>E</span>
                    <span>E</span>
                    <span>D</span>
                    <span class="name-space"></span>
                    <span>V</span>
                    <span>H</span>
                </div>
            </a>
            <div class="sidebar-bottom">
                <a href="/rabbithole" class="rabbit-hole-link" title="Follow the rabbit hole...">
                    <svg class="svg-icon rabbit-icon"><use href="#icon-rabbit" /></svg>
                </a>
            </div>
        </aside>

        <div class="layout-wrapper">
            <nav class="top-nav">
                <ul class="nav-links">
                    <li><a href="/" class="nav-link">Home</a></li>
                    <li><a href="/about" class="nav-link">About</a></li>
                    <li><a href="/posts" class="nav-link">Posts</a></li>
                    <li><a href="/projects" class="nav-link">Projects</a></li>
                    <li><a href="/contact" class="nav-link">Contact</a></li>
                </ul>
            </nav>

            <main class="content">
                <div class="post-metadata"></div>

                <article class="">
                    <p>write or draw me a message <strong>anonymously</strong>.</p>
                    <style>
                        textarea {
                            box-sizing: border-box;
                            width: 100%;
                            padding: var(--space-3);
                            font-family: var(--font-body);
                            font-size: var(--text-base);
                            background-color: var(--bg-card);
                            color: var(--text-primary);
                            border: 1px dotted var(--border-dotted);
                            margin-bottom: var(--space-2);
                            resize: vertical;
                            outline: none;
                        }

                        textarea:focus {
                            border-style: solid;
                            border-color: var(--text-secondary);
                        }

                        .paint-canvas {
                            box-sizing: border-box;
                            width: 100%;
                            height: 400px;
                            background: #ffffff;
                            border: 1px dotted var(--border-dotted);
                            display: block;
                            margin-top: var(--space-2);
                            touch-action: none;
                            cursor: crosshair;
                        }

                        .drawing-controls {
                            display: flex;
                            align-items: center;
                            gap: var(--space-4);
                            margin-top: var(--space-2);
                            font-family: var(--font-display);
                            font-size: var(--text-xs);
                            text-transform: uppercase;
                        }

                        .color-picker {
                            background: var(--bg-card);
                            border: 1px dotted var(--border-dotted);
                            cursor: pointer;
                            padding: 2px;
                            width: 40px;
                            height: 30px;
                        }

                        .line-range {
                            flex-grow: 1;
                            cursor: pointer;
                            accent-color: var(--text-secondary);
                        }

                        .message-section {
                            margin: var(--space-6) 0;
                            padding: var(--space-4);
                            border: 1px dotted var(--border-dotted);
                            background-color: var(--bg-surface);
                            display: flex;
                            flex-direction: column;
                        }

                        .section-title {
                            font-family: var(--font-display);
                            font-size: var(--text-sm);
                            text-transform: uppercase;
                            letter-spacing: 0.1em;
                            margin-bottom: var(--space-2);
                            display: block;
                            text-align: center;
                        }
                    </style>
                    <div class="message-container">
                        <div class="message-section">
                            <span class="section-title">‚úçÔ∏è Send a Message</span>
                            <textarea
                                id="message"
                                rows="8"
                                placeholder="Type your anonymous message here..."
                            ></textarea>
                            <div class="button-wrapper align-center">
                                <h4 class="post-button" id="msg-button" onclick="send_message()">Send Message</h4>
                            </div>
                        </div>
                        <div class="message-section">
                            <span class="section-title">üñåÔ∏è Send a Drawing</span>
                            <div class="drawing-controls">
                                <input type="color" class="js-color-picker color-picker" value="#000000" />
                                <input type="range" class="js-line-range line-range" min="1" max="50" value="2" />
                                <span><span class="js-range-value">2</span>px</span>
                            </div>
                            <canvas class="js-paint paint-canvas"></canvas>
                            <div class="button-wrapper align-center">
                                <h4 class="post-button" id="draw-button" onclick="send_drawing()">Send Drawing</h4>
                            </div>
                        </div>
                    </div>
                    <script>
                        (function initializeDrawingModule() {
                            const paintCanvas = document.querySelector(".js-paint");

                            if (!paintCanvas) {
                                console.error("[paint-canvas] Canvas element not found; drawing has been disabled.");
                                return;
                            }

                            const context = paintCanvas.getContext("2d");
                            const tempCanvas = document.createElement("canvas");
                            const tempContext = tempCanvas.getContext("2d");
                            const colorPicker = document.querySelector(".js-color-picker");
                            const lineWidthRange = document.querySelector(".js-line-range");
                            const lineWidthLabel = document.querySelector(".js-range-value");

                            /**
                             * Drawing module orchestrates a temporary off-screen canvas and the main canvas to create smooth
                             * strokes, while ensuring the rendering space matches the device pixel ratio.
                             *
                             * Security considerations: logs emit only sizing metadata and configuration changes, never PII.
                             */
                            if (!context || !tempContext) {
                                console.error(
                                    "[paint-canvas] Failed to obtain a 2D rendering context; drawing has been disabled.",
                                );
                                return;
                            }

                            let currentStrokeStyle = colorPicker ? colorPicker.value : "#000000";
                            let currentLineWidth = lineWidthRange ? parseInt(lineWidthRange.value, 10) || 1 : 1;

                            const logPaintEvent = (message, data = {}) => {
                                console.info("[paint-canvas]", message, data);
                            };

                            const applyStrokeSettings = () => {
                                context.lineCap = "round";
                                context.lineJoin = "round";
                                context.lineWidth = currentLineWidth;
                                context.strokeStyle = currentStrokeStyle;

                                tempContext.lineCap = "round";
                                tempContext.lineJoin = "round";
                                tempContext.lineWidth = currentLineWidth;
                                tempContext.strokeStyle = currentStrokeStyle;
                            };

                            const detectMob = () => window.innerWidth <= 800;

                            /**
                             * Resize both canvases to follow layout changes and honour the device pixel ratio. Resetting the
                             * transform on each call prevents cumulative scaling that previously displaced strokes below the
                             * user's cursor.
                             */
                            const resizeCanvas = () => {
                                const rect = paintCanvas.getBoundingClientRect();

                                if (!rect.width || !rect.height) {
                                    console.warn(
                                        "[paint-canvas] Skipping resize due to zero-sized bounding rectangle.",
                                        {
                                            width: rect.width,
                                            height: rect.height,
                                        },
                                    );
                                    return;
                                }

                                const dpr = window.devicePixelRatio || 1;

                                paintCanvas.width = rect.width * dpr;
                                paintCanvas.height = rect.height * dpr;
                                tempCanvas.width = rect.width * dpr;
                                tempCanvas.height = rect.height * dpr;

                                paintCanvas.style.width = `${rect.width}px`;
                                paintCanvas.style.height = `${rect.height}px`;
                                tempCanvas.style.width = `${rect.width}px`;
                                tempCanvas.style.height = `${rect.height}px`;

                                context.setTransform(1, 0, 0, 1, 0, 0);
                                tempContext.setTransform(1, 0, 0, 1, 0, 0);

                                context.scale(dpr, dpr);
                                tempContext.scale(dpr, dpr);

                                applyStrokeSettings();

                                logPaintEvent("Canvas resized", {
                                    width: rect.width,
                                    height: rect.height,
                                    dpr,
                                });
                            };

                            if (detectMob()) {
                                paintCanvas.style.height = "320px";
                            }

                            if (colorPicker) {
                                colorPicker.addEventListener("change", (event) => {
                                    currentStrokeStyle = event.target.value;
                                    applyStrokeSettings();
                                    logPaintEvent("Stroke colour changed", { stroke: currentStrokeStyle });
                                });
                            }

                            if (lineWidthRange && lineWidthLabel) {
                                lineWidthLabel.innerHTML = currentLineWidth;
                                lineWidthRange.addEventListener("input", (event) => {
                                    const width = parseInt(event.target.value, 10) || 1;
                                    currentLineWidth = width;
                                    lineWidthLabel.innerHTML = width;
                                    applyStrokeSettings();
                                    logPaintEvent("Line width changed", { width: currentLineWidth });
                                });
                            }

                            applyStrokeSettings();

                            if (document.readyState === "loading") {
                                document.addEventListener("DOMContentLoaded", () => {
                                    resizeCanvas();
                                    setTimeout(resizeCanvas, 100);
                                });
                            } else {
                                resizeCanvas();
                                setTimeout(resizeCanvas, 100);
                            }

                            window.addEventListener("resize", resizeCanvas);

                            let isDrawing = false;
                            let points = [];
                            let savedImageData = null;

                            /**
                             * Convert a pointer event into canvas-relative coordinates using CSS pixels so the drawing logic can
                             * stay agnostic of the backing store resolution.
                             */
                            const getPointerPosition = (canvas, evt) => {
                                const rect = canvas.getBoundingClientRect();
                                if ("touches" in evt && evt.touches.length) {
                                    const touch = evt.touches[0];
                                    return {
                                        x: touch.clientX - rect.left,
                                        y: touch.clientY - rect.top,
                                    };
                                }

                                return {
                                    x: evt.clientX - rect.left,
                                    y: evt.clientY - rect.top,
                                };
                            };

                            /**
                             * Render a smoothed stroke following the historical pointer trail, using quadratic curves for a
                             * natural brush appearance.
                             */
                            const drawSmoothLine = (inputPoints, ctx) => {
                                if (inputPoints.length === 0) {
                                    return;
                                }

                                ctx.beginPath();
                                ctx.moveTo(inputPoints[0].x, inputPoints[0].y);

                                for (let i = 1; i < inputPoints.length - 2; i++) {
                                    const xc = (inputPoints[i].x + inputPoints[i + 1].x) / 2;
                                    const yc = (inputPoints[i].y + inputPoints[i + 1].y) / 2;
                                    ctx.quadraticCurveTo(inputPoints[i].x, inputPoints[i].y, xc, yc);
                                }

                                if (inputPoints.length > 2) {
                                    const last = inputPoints.length - 1;
                                    ctx.quadraticCurveTo(
                                        inputPoints[last - 1].x,
                                        inputPoints[last - 1].y,
                                        inputPoints[last].x,
                                        inputPoints[last].y,
                                    );
                                }

                                ctx.stroke();
                            };

                            const startDrawing = (event) => {
                                isDrawing = true;
                                points = [];
                                points.push(getPointerPosition(paintCanvas, event));
                                savedImageData = context.getImageData(0, 0, paintCanvas.width, paintCanvas.height);
                            };

                            const draw = (event) => {
                                if (!isDrawing) {
                                    return;
                                }

                                event.preventDefault();
                                points.push(getPointerPosition(paintCanvas, event));

                                if (savedImageData) {
                                    context.putImageData(savedImageData, 0, 0);
                                }

                                drawSmoothLine(points, context);
                            };

                            const stopDrawing = () => {
                                if (!isDrawing) {
                                    return;
                                }

                                isDrawing = false;

                                if (savedImageData) {
                                    context.putImageData(savedImageData, 0, 0);
                                }

                                drawSmoothLine(points, context);
                                points = [];
                                savedImageData = null;
                            };

                            paintCanvas.addEventListener("mousedown", startDrawing);
                            paintCanvas.addEventListener("mousemove", draw);
                            paintCanvas.addEventListener("mouseup", stopDrawing);
                            paintCanvas.addEventListener("mouseout", stopDrawing);

                            paintCanvas.addEventListener("touchstart", startDrawing);
                            paintCanvas.addEventListener("touchmove", draw);
                            paintCanvas.addEventListener("touchend", stopDrawing);

                            const API_URL = "https://api.mufeedvh.com";

                            let lastSentMessage = null;
                            let lastSentDrawing = null;
                            let isSendingMessage = false;
                            let isSendingDrawing = false;

                            const send_message = () => {
                                if (isSendingMessage) {
                                    return;
                                }

                                const message = document.getElementById("message").value;
                                const button = document.getElementById("msg-button");

                                if (lastSentMessage !== null && message === lastSentMessage) {
                                    button.style.backgroundColor = "#ffa500";
                                    button.style.color = "white";
                                    button.innerHTML = "Message already sent";
                                    return;
                                }

                                isSendingMessage = true;
                                button.disabled = true;
                                button.style.backgroundColor = "#808080";
                                button.innerHTML = "Sending...";

                                const xhttp = new XMLHttpRequest();

                                xhttp.onreadystatechange = function () {
                                    if (this.readyState === 4 && this.status === 200) {
                                        const token = JSON.parse(this.responseText).token;
                                        console.log("acquired token: " + token);

                                        const innerXhttp = new XMLHttpRequest();
                                        const url = API_URL + "/message";

                                        innerXhttp.onreadystatechange = function () {
                                            if (this.readyState === 4 && this.status === 200) {
                                                lastSentMessage = message;
                                                button.style.backgroundColor = "lightgreen";
                                                button.style.color = "black";
                                                button.innerHTML = JSON.parse(innerXhttp.responseText).message;
                                                button.disabled = false;
                                                isSendingMessage = false;
                                            } else if (this.readyState === 4 && this.status !== 200) {
                                                button.style.color = "white";
                                                button.style.backgroundColor = "red";
                                                button.innerHTML = "Failed to send message";
                                                button.disabled = false;
                                                isSendingMessage = false;
                                            }
                                        };

                                        innerXhttp.open("POST", url);
                                        innerXhttp.setRequestHeader("Content-Type", "application/json; charset=UTF-8");
                                        innerXhttp.send(
                                            JSON.stringify({
                                                token: token,
                                                message: message,
                                            }),
                                        );
                                    } else if (this.readyState === 4 && this.status !== 200) {
                                        button.style.color = "white";
                                        button.style.backgroundColor = "red";
                                        button.innerHTML = "Failed to get token";
                                        button.disabled = false;
                                        isSendingMessage = false;
                                    }
                                };

                                xhttp.open("GET", API_URL + "/get_token", true);
                                xhttp.send();
                            };

                            const send_drawing = () => {
                                if (isSendingDrawing) {
                                    return;
                                }

                                const drawingData = paintCanvas.toDataURL();
                                const button = document.getElementById("draw-button");

                                if (lastSentDrawing !== null && drawingData === lastSentDrawing) {
                                    button.style.backgroundColor = "#ffa500";
                                    button.style.color = "white";
                                    button.innerHTML = "Drawing already sent";
                                    return;
                                }

                                isSendingDrawing = true;
                                button.disabled = true;
                                button.style.backgroundColor = "#808080";
                                button.innerHTML = "Sending...";

                                const xhttp = new XMLHttpRequest();

                                xhttp.onreadystatechange = function () {
                                    if (this.readyState === 4 && this.status === 200) {
                                        const token = JSON.parse(this.responseText).token;
                                        console.log("acquired token: " + token);

                                        const innerXhttp = new XMLHttpRequest();
                                        const url = API_URL + "/drawing";

                                        innerXhttp.onreadystatechange = function () {
                                            if (this.readyState === 4 && this.status === 200) {
                                                lastSentDrawing = drawingData;
                                                button.style.backgroundColor = "lightgreen";
                                                button.style.color = "black";
                                                button.innerHTML = JSON.parse(innerXhttp.responseText).message;
                                                button.disabled = false;
                                                isSendingDrawing = false;
                                            } else if (this.readyState === 4 && this.status !== 200) {
                                                button.style.color = "white";
                                                button.style.backgroundColor = "red";
                                                button.innerHTML = "Failed to send drawing";
                                                button.disabled = false;
                                                isSendingDrawing = false;
                                            }
                                        };

                                        innerXhttp.open("POST", url);
                                        innerXhttp.setRequestHeader("Content-Type", "application/json; charset=UTF-8");
                                        innerXhttp.send(
                                            JSON.stringify({
                                                token: token,
                                                message: drawingData,
                                            }),
                                        );
                                    } else if (this.readyState === 4 && this.status !== 200) {
                                        button.style.color = "white";
                                        button.style.backgroundColor = "red";
                                        button.innerHTML = "Failed to get token";
                                        button.disabled = false;
                                        isSendingDrawing = false;
                                    }
                                };

                                xhttp.open("GET", API_URL + "/get_token", true);
                                xhttp.send();
                            };

                            window.send_message = send_message;
                            window.send_drawing = send_drawing;
                        })();
                    </script>
                </article>

                <div class="back-to-directory">
                    <a href="/">‚Üê Back to Directory</a>
                </div>
            </main>
        </div>

        <script src="/codeblock-enhancer.js"></script>
        <script src="/blog-actions.js"></script>
        <script src="/easter-egg.js"></script>
    </body>
</html>
